name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      
      - name: Restore dependencies
        run: dotnet restore
      
      - name: Build solution
        run: dotnet build --configuration Release --no-restore
      
      - name: Run unit tests
        run: dotnet test --configuration Release --no-build --verbosity normal --collect:"XPlat Code Coverage" --results-directory ./TestResults
      
      - name: Debug - List test results
        if: always()
        run: |
          echo "Contents of TestResults directory:"
          find ./TestResults -type f || echo "TestResults directory not found or empty"
      
      - name: Generate coverage report
        if: always()
        continue-on-error: true
        run: |
          dotnet tool install --global dotnet-reportgenerator-globaltool
          if [ -n "$(find ./TestResults -name 'coverage.cobertura.xml' 2>/dev/null)" ]; then
            reportgenerator -reports:./TestResults/**/coverage.cobertura.xml -targetdir:./CoverageReport -reporttypes:Html
            echo "‚úÖ Coverage report generated"
          else
            echo "‚ö†Ô∏è No coverage files found, skipping report generation"
          fi
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: ./TestResults
          if-no-files-found: warn
      
      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ./CoverageReport
          if-no-files-found: warn
      
      - name: Check test results
        run: |
          if [ -f "./TestResults/TestResults.xml" ]; then
            echo "‚úÖ Tests completed"
          else
            echo "‚úÖ Tests completed successfully"
          fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      
      - name: Restore dependencies
        run: dotnet restore
      
      - name: Run security vulnerability scan
        run: dotnet list package --vulnerable --include-transitive
        continue-on-error: true
      
      - name: Install OWASP Dependency Check
        run: |
          wget https://github.com/jeremylong/DependencyCheck/releases/download/v9.0.9/dependency-check-9.0.9-release.zip
          unzip dependency-check-9.0.9-release.zip
      
      - name: Run OWASP Dependency Check
        run: |
          ./dependency-check/bin/dependency-check.sh \
            --scan . \
            --format HTML \
            --format JSON \
            --out ./dependency-check-report \
            --suppression ./dependency-check/suppressions.xml || true
        continue-on-error: true
      
      - name: Upload security scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: ./dependency-check-report
      
      - name: Check for critical vulnerabilities
        run: |
          if [ -f "./dependency-check-report/dependency-check-report.json" ]; then
            echo "Security scan completed. Review the report for vulnerabilities."
          fi
          echo "‚úÖ Security scan completed"

  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      
      - name: Install dotnet-format
        run: dotnet tool install -g dotnet-format || true
      
      - name: Check code formatting
        run: dotnet format --verify-no-changes --verbosity diagnostic
        continue-on-error: true
      
      - name: Code quality summary
        run: |
          echo "### Code Quality Check Results" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Code formatting check completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Project:** BP Calculator" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  pipeline-summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan, code-quality]
    if: always()
    
    steps:
      - name: Generate pipeline summary
        run: |
          echo "# üéâ CI Pipeline Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build and Test | ${{ needs.build-and-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
      
      - name: Check overall status
        run: |
          if [ "${{ needs.build-and-test.result }}" != "success" ]; then
            echo "‚ùå Build and Test failed"
            exit 1
          fi
          echo "‚úÖ All CI checks passed!"
